
pipeline {
    agent any

    parameters {
        choice(name: 'ACTION', choices: ['apply', 'destroy'], description: 'Select action: apply or destroy')
    }

    environment {
        TERRAFORM_WORKSPACE = "/var/lib/jenkins/workspace/terraform_ansible_job_2/terraform_script/"
        INSTALL_WORKSPACE = "/var/lib/jenkins/workspace/terraform_ansible_job_2/"
    }

    stages {
        // ... (other stages remain unchanged)

        stage('Nginx Deploy') {
            when {
                expression { params.ACTION == 'apply' }
            }
            steps {
                script {
                    // Change ownership and permissions of the nginx.pem file
                    sh "sudo chown jenkins:jenkins ${env.INSTALL_WORKSPACE}/nginx.pem"
                    sh "sudo chmod 600 ${env.INSTALL_WORKSPACE}/nginx.pem"

                    // Debugging: Print the contents and permissions of the SSH key
                    echo "Contents of nginx.pem:"
                    sh "cat ${env.INSTALL_WORKSPACE}/nginx.pem"
                    echo "Permissions of nginx.pem:"
                    sh "ls -l ${env.INSTALL_WORKSPACE}/nginx.pem"

                    // Deploy Nginx using Ansible
                    dir("${env.INSTALL_WORKSPACE}") {
                        """
                        ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook nginx_tool.yml
                        """
                    }
                }
            }
        }
    }

    post {
        success {
            echo 'Succeeded!'
        }
        failure {
            echo 'Failed!'
        }
    }
}
